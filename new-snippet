#!/usr/bin/env bash
set -euo pipefail

SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

read -rp "Category: " CATEGORY
read -rp "Snippet title (kebab-case): " TITLE
read -rp "Snippet code (optional, leave blank to edit in VS Code): " SNIPPET_CODE

if [[ -z "$CATEGORY" || -z "$TITLE" ]]; then
  echo "Error: Both category and title are required."
  exit 1
fi

TARGET_DIR="$SCRIPT_DIR/$CATEGORY"
mkdir -p "$TARGET_DIR"

FILE_PATH="$TARGET_DIR/$TITLE.md"

if [[ -e "$FILE_PATH" ]]; then
  echo "Error: Snippet already exists at $FILE_PATH"
  exit 1
fi

OLDIFS=$IFS
IFS='-'
read -ra TITLE_PARTS <<< "$TITLE"
IFS=$OLDIFS
PRETTY_TITLE=""
for PART in "${TITLE_PARTS[@]}"; do
  FIRST_CHAR="${PART:0:1}"
  FIRST_CHAR_UPPER=$(printf '%s' "$FIRST_CHAR" | tr '[:lower:]' '[:upper:]')
  PRETTY_TITLE+="${FIRST_CHAR_UPPER}${PART:1} "
done
PRETTY_TITLE="${PRETTY_TITLE% }"

CODE_LANG="txt"

if [[ -n "$SNIPPET_CODE" ]]; then
  CODE_BLOCK="$SNIPPET_CODE"
else
  CODE_BLOCK="<replace with code snippet>"
fi

cat > "$FILE_PATH" <<EOF
---
Title: $PRETTY_TITLE
Description: Code snippet for $PRETTY_TITLE.
Tags:
  - TODO: add tags
---

\`\`\`$CODE_LANG
$CODE_BLOCK
\`\`\`
EOF

if [[ -n "$SNIPPET_CODE" ]]; then
  echo "New snippet created at $FILE_PATH"
elif command -v code >/dev/null 2>&1; then
  code "$FILE_PATH"
elif command -v code-insiders >/dev/null 2>&1; then
  code-insiders "$FILE_PATH"
else
  echo "New snippet created at $FILE_PATH"
fi