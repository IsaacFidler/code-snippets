#!/usr/bin/env bash
set -euo pipefail

SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
SNIPPETS_DIR="$SCRIPT_DIR/snippets"

# Convert any input to kebab-case
to_kebab_case() {
  local input="$1"
  echo "$input" \
    | sed 's/\([a-z]\)\([A-Z]\)/\1-\2/g' \
    | sed 's/\([A-Z][A-Z]*\)\([A-Z][a-z]\)/\1-\2/g' \
    | tr '[:upper:]' '[:lower:]' \
    | tr ' _' '--' \
    | sed 's/[^a-z0-9-]//g' \
    | sed 's/--*/-/g' \
    | sed 's/^-//' \
    | sed 's/-$//'
}

# Get existing categories (compatible with bash 3.x)
CATEGORIES=()
while IFS= read -r dir; do
  CATEGORIES+=("$dir")
done < <(find "$SNIPPETS_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort)

echo "Existing categories:"
for i in "${!CATEGORIES[@]}"; do
  printf "  %2d) %s\n" "$((i + 1))" "${CATEGORIES[$i]}"
done
echo "   n) New category"
echo

read -rp "Select category (number or name): " CATEGORY_INPUT

# Handle category selection
if [[ "$CATEGORY_INPUT" =~ ^[0-9]+$ ]]; then
  INDEX=$((CATEGORY_INPUT - 1))
  if [[ $INDEX -ge 0 && $INDEX -lt ${#CATEGORIES[@]} ]]; then
    CATEGORY="${CATEGORIES[$INDEX]}"
  else
    echo "Error: Invalid category number"
    exit 1
  fi
elif [[ "$CATEGORY_INPUT" == "n" ]]; then
  read -rp "New category name: " CATEGORY
  CATEGORY=$(to_kebab_case "$CATEGORY")
else
  CATEGORY=$(to_kebab_case "$CATEGORY_INPUT")
fi

read -rp "Snippet title: " TITLE
TITLE=$(to_kebab_case "$TITLE")

echo "â†’ Using: $CATEGORY/$TITLE.md"

# Common languages
echo
echo "Common languages: bash, typescript, tsx, javascript, sql, graphql, prisma, json, yaml, dockerfile"
read -rp "Code language [bash]: " CODE_LANG
CODE_LANG="${CODE_LANG:-bash}"

read -rp "Snippet code (optional, leave blank to edit in editor): " SNIPPET_CODE

TARGET_DIR="$SNIPPETS_DIR/$CATEGORY"
mkdir -p "$TARGET_DIR"

FILE_PATH="$TARGET_DIR/$TITLE.md"

if [[ -e "$FILE_PATH" ]]; then
  echo "Error: Snippet already exists at $FILE_PATH"
  exit 1
fi

# Convert kebab-case to Title Case for display
OLDIFS=$IFS
IFS='-'
read -ra TITLE_PARTS <<< "$TITLE"
IFS=$OLDIFS
PRETTY_TITLE=""
for PART in "${TITLE_PARTS[@]}"; do
  FIRST_CHAR="${PART:0:1}"
  FIRST_CHAR_UPPER=$(printf '%s' "$FIRST_CHAR" | tr '[:lower:]' '[:upper:]')
  PRETTY_TITLE+="${FIRST_CHAR_UPPER}${PART:1} "
done
PRETTY_TITLE="${PRETTY_TITLE% }"

if [[ -n "$SNIPPET_CODE" ]]; then
  CODE_BLOCK="$SNIPPET_CODE"
else
  CODE_BLOCK="<replace with code snippet>"
fi

cat > "$FILE_PATH" <<EOF
---
Title: $PRETTY_TITLE
Description: Code snippet for $PRETTY_TITLE.
Tags:
  - $CATEGORY
---

\`\`\`$CODE_LANG
$CODE_BLOCK
\`\`\`
EOF

if [[ -n "$SNIPPET_CODE" ]]; then
  echo "New snippet created at $FILE_PATH"
else
  if command -v vim >/dev/null 2>&1; then
    vim "$FILE_PATH"
  elif command -v code >/dev/null 2>&1; then
    code "$FILE_PATH"
  elif command -v code-insiders >/dev/null 2>&1; then
    code-insiders "$FILE_PATH"
  else
    echo "New snippet created at $FILE_PATH"
  fi
fi

# Auto-commit the new snippet
cd "$SCRIPT_DIR"
git add "$FILE_PATH"
git commit -m "Add snippet: $CATEGORY/$TITLE"
echo "Committed: $CATEGORY/$TITLE"
